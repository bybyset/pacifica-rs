# 用户指南

## 常见名词及解释

- **副本(Replica)**  
  数据存储的基本单元
- **副本组(ReplicaGroup)**  
  由一个或多个副本组成
- **主副本(Primary)**  
  每个副本组有且仅有一个副本的状态为主副本，负责处理写请求，并将操作日志复制发送到其他副本
- **从副本(Secondary)**  
  每个副本组可以有多个副本的状态为从副本，当主副本故障后，可以竞争并最终有且仅有一个从副本竟选成为主副本，每个从副本都将参与“写”请求的投票
- **候选副本(Candidate)**  
  副本故障后，状态变为候选副本，并开启恢复流程，将从主副本复制快照和操作日志，以追赶主副本，并在追赶成功后，恢复状态为从副本
- **日志序号**  
  每个副本写请求分配一个单调递增的操作日志序号
- **任期(term)**
  表示当前主副本的在任期号，发生主副本变更后，任期号自增，通常我们用从1开始单调递增的整数值表示


## 模型架构
![model](https://github.com/bybyset/pacifica-rs/blob/main/docs/PacificA%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%9E%8B.png)  
如上图所示，在PacificA中，将“数据存储复制”与“副本配置管理”分离，
其中“数据存储集群”数据以“副本”的形式分布在不同的节点，多个“副本”组成“副本组”，
也可以称作“切片”，多个副本间通过复制主副本的操作日志实现数据一致。
“配置管理集群”负责维护系统中所有副本组的配置。对于每个副本组，
配置管理集群将维护当前的配置及其版本号。  
在pacifica-rs中，由于每个应用的情况不同，没有通用的标准，故我们没有提供相应的配置集群的实现，
然而我们定义了相应的接口，各个应用可以依据自身特点实现即可，可以是基于任何算法的，如zookeeper、raft等。
此外，在counter的例子中，你可以找到我们基于SOFAJRaft的实现，或许你可以参考。


## 副本状态转换图
![state](https://github.com/bybyset/pacifica-rs/blob/main/docs/PacificA%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png)  
在pacifica-rs中采用租期(Leases)的方式实现主/从副本间的故障检测。
1. 主副本定期向从副本发送心跳请求，并收到“成功”的响应后即为获得来自指定从副本的租约(lease),
   若主副本长时间未收到心跳响应(超过租赁期lease period)，则认为从副本故障，并联系配置管理集群要求将故障的从副本从副本组中移除。
   若移除成功，故障从副本的状态将由Secondary转为Candidate(候选状态)。
2. 同时，从副本维护了最近一次来自主副本的心跳请求，若长时间未收到来自主副本的心跳请求(超过宽限期grace period)，
   则认为主副本故障，将联系配置管理集群要求移除故障主副本并竟选成为新的主副本。若成功竞选，则该从副本的状态由Secondary转变为Primary，
   同时旧的主副本的状态由Primary转为Candidate。
3. 对于候选状态的副本，将定时向主副本发送恢复请求，主副本收到恢复请求后，开始向候选副本发送快照或复制日志，
   一旦候选副本的操作日志的序号追赶上了，主副本将联系配置管理集群要求将候选副本加入副本组内，成功后，候选副本的状态由Candidate转为Secondary。
4. 在配置管理集群中，为每个副本组维护了一个单调递增的版本号(version),每次副本组的变更都会让该版本号自增。
   每次配置变更请求都会携带当前配置的版本号，当且仅当请求中的版本号于配置管理集群中的版本号匹配时，才会处理并响应请求，否则拒绝。
   这可以保证多个从副本同时竞争选主时，只有一个从副本可以成功，其他均为失败。



## 副本启动
配置集群保存了整个副本组的状态，包含各个副本的状态等，各个副本启动时，都将以配置集群上对应的状态启动。
任何状态的副本启动时，都会执行以下两步：
1. 如果启用了快照(Snapshot)的功能，副本状态机将加载快照至状态机，然后从checkpoint(快照数据的日志index)开始继续回放操作日志至状态机，直至本地日志的最后一条日志。
2. 如果未启用快照功能，将重放本地所有操作日志至状态机。

### 主副本(Primary)启动
将提交一个“NO_OP”类型的操作日志，用以对齐其他副本的日志队列，即Reconciliation。

### 候选副本(Candidate)启动
开启定时调度作业，联系主副本并拉取快照和操作日志，直到追赶上主副本后成为Secondary状态，停止该调度作业。



## 一致性和可用性设计
这里我们讨论下pacifica-rs在遇到副本或节点故障时副本组的一致性和可用性的情况。  
故障包含且不仅包含以下情况：
- 磁盘损坏
- OutOfMemory故障宕机或频繁Full GC导致运行缓慢
- 强制kill应用导致宕机
- 断电宕机
- 网络故障

需要注意的是：
- 单个副本没有任何可用性，保证副本组中包含两个及以上的副本，才可以提供可用性的保证。
- 配置集群中的副本组有且仅有一个副本的状态是Primary。

针对以下两种服务类型讨论：
- **读服务**  
  读取副本状态机中数据的服务。

- **写服务**  
  更改(增/删/改)副本状态机中数据的服务。  
  当且仅当存在主副本时提供该服务。


### 一致性
针对读服务的一致性
- 可以从主副本(Primary)读取，此时将提供强一致性的保证。
- 也可以读取从副本(Secondary)数据，但只能提供弱一致性，即可能读取不是最新的数据，存在脏读。
- 不建议读取候选副本(Candidate)数据。

### 可用性
**单个副本故障**
1. 主副本(Primary)故障，副本组最多在宽限期(grace period)时间后开始选举主副本，在产生新的主副本之前，写服务不可用，读服务正常可用。
2. 从副本(Secondary)故障，不影响读服务，写服务将出现“抖动”，即主副本将最多等待租赁期(lease period)时间，并在移除故障的从副本后，返回响应。
3. 候选副本(Candidate)故障，不影响读/写服务。

**少数或多数副本故障**  
同单个副本故障，当且仅当有一个主副本在线时即可提供读/写服务。